{% extends 'base.html' %}

{% block title %}Map View{% endblock %}

{% block content %}
<h1>History Detection Objects</h1>
<div id="mapContainer" style="width: 100%; height: 600px; margin-top: 20px;"></div>
<!-- 图片放大样式 -->
<style>
    .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.9);
    }

    .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
        max-height: 80%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
</style>
<!-- 添加模态框 -->
<div id="imageModal" class="image-modal">
    <img class="modal-content" id="modalImage">
</div>
<!-- 引入高德地图API -->
<script src="https://webapi.amap.com/maps?v=2.0&key=0dcf12c80c3856bf921f1468202f01ca"></script>
<script>
    async function loadHistoryData() {
        try {
            const response = await fetch('/history_data');
            const data = await response.json();
            console.log(data);
            return data.history_data;
        } catch (error) {
            console.error('加载历史数据时出错:', error);
            return [];
        }
    }

    // 打开图片模态框
    function openImageModal(imgSrc) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        modal.style.display = "block";
        modalImg.src = imgSrc;
        // 点击模态框外关闭
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }

    async function initMap() {
        const historyData = await loadHistoryData();
        const map = new AMap.Map('mapContainer', {
            zoom: 12,
            center: [118.7674, 32.0415]
        });

        // 绘制红色区域
        const redArea = new AMap.Polygon({
            path: [
                [118.81122 - 0.003, 32.068251 - 0.003],
                [118.81122 + 0.003, 32.068251 - 0.003],
                [118.81122 + 0.003, 32.068251 + 0.003],
                [118.81122 - 0.003, 32.068251 + 0.003]
            ],
            fillColor: "#ffad80",
            fillOpacity: 0.4,
            strokeWeight: 1
        });
        redArea.setMap(map);

        // 添加文本标注
        const textLabel = new AMap.Text({
            text: '该地水质质量：中等，有部分垃圾需要打捞',
            position: [118.81122, 32.068251],
            offset: new AMap.Pixel(0, -20),
            style: {
                backgroundColor: 'white',
                border: '1px solid #ccc',
                padding: '5px',
                borderRadius: '3px'
            }
        });
        textLabel.setMap(map);

        historyData.forEach(record => {
            const [latitude, longitude] = record.gps_location.split(', ').map(Number);
            console.log('解析后的经纬度:', latitude, longitude);
            if (!isNaN(latitude) && !isNaN(longitude)) {
                const marker = new AMap.Marker({
                    position: [118.81122 + Math.random() / 1000, 32.068251 + Math.random() / 1000],
                    map: map
                });

                marker.on('click', function () {
                    openImageModal(`data:image/jpeg;base64,${record.image_data}`);
                });
            }
        });
    }

    // 页面加载完成后初始化地图
    window.onload = initMap;
</script>
{% endblock %}