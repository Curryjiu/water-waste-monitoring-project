{% extends 'base.html' %}

{% block title %}
Aqua AI
{% endblock %}

{% block content %}

<div class="row g-4">
    <div class="col-6">
        <h2>Raw Frame</h2>
        <img id="videoFrame" src="/raw_frame" class="img-fluid">
    </div>
    <div class="col-6">
        <h2>Detected Frame</h2>
        <img id="detectedVideoFrame" src="/detected_frame" class="img-fluid">
    </div>
</div>

<style>
    #detectionInfo th:nth-child(1),
    #detectionInfo td:nth-child(1) {
        width: 30%;
    }
    
    #detectionInfo th:nth-child(2),
    #detectionInfo td:nth-child(2) {
        width: 20%;
    }
    
    #detectionInfo th:nth-child(3),
    #detectionInfo td:nth-child(3) {
        width: 50%;
    }
</style>

<div class="mt-4">
    <h2>Detected Objects Info</h2>
    <table id="detectionInfo" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Confidence</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    const videoFrame = document.getElementById('videoFrame');
    const detectedVideoFrame = document.getElementById('detectedVideoFrame');
    const detectionInfoTable = document.getElementById('detectionInfo').getElementsByTagName('tbody')[0];

    function updateFrame() {
        const timestamp = new Date().getTime();
        videoFrame.src = `/raw_frame?t=${timestamp}`;
        detectedVideoFrame.src = `/detected_frame?t=${timestamp}`;
    }

    async function updateDetectionInfo() {
        try {
            const response = await fetch('/detection_info');
            const data = await response.json();

            let infoHtml = '';
            data.detections.forEach(detection => {
                infoHtml += `
                    <tr>
                        <td>${detection.name}</td>
                        <td>${(detection.confidence * 100).toFixed(2)}%</td>
                        <td>(${detection.x1}, ${detection.y1}) - (${detection.x2}, ${detection.y2})</td>
                    </tr>
                `;
            });

            detectionInfoTable.innerHTML = infoHtml || '<tr><td colspan="3">未检测到物品</td></tr>';
        } catch (error) {
            console.error('获取检测信息失败:', error);
            detectionInfoTable.innerHTML = '<tr><td colspan="3" class="table-danger">获取检测信息失败</td></tr>';
        }
    }

    setInterval(updateFrame, 100);
    setInterval(updateDetectionInfo, 100);
</script>
{% endblock %}